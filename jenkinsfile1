pipeline {
    agent any

    triggers {
        pollSCM('H/15 0 * * *') // Runs every day at midnight
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                    if (isUnix()) {
                        sh '''
                            # Set up virtual environment
                            python3 -m venv venv
                            . venv/bin/activate
                            pip install --upgrade pip
                            
                            # Install dependencies
                            pip install -r requirements.txt
                            pip install pytest pytest-html pytest-xdist selenium webdriver-manager
                        '''
                    } else {
                        bat '''
                            # Set up virtual environment
                            python -m venv venv
                            venv\\Scripts\\activate
                            pip install --upgrade pip
                            
                            # Install dependencies
                            pip install -r requirements.txt
                            pip install pytest pytest-html pytest-xdist selenium webdriver-manager
                        '''
                    }
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    if (isUnix()) {
                        sh '''
                            . venv/bin/activate
                            
                            # Ensure WebDriver Manager fetches the latest ChromeDriver
                            export PYTHONPATH=$WORKSPACE
                            pytest testCases/* --alluredir=./allurereports --html=Reports/index.html
                        '''
                    } else {
                        bat '''
                            venv\\Scripts\\activate
                            
                            # Ensure WebDriver Manager fetches the latest ChromeDriver
                            set PYTHONPATH=%WORKSPACE%
                            pytest testCases/* --alluredir=./allurereports --html=Reports\\index.html
                        '''
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution complete!'
        }
    }
}

